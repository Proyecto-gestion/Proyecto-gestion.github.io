<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Plataforma de Gesti√≥n de Proyectos</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <main class="container" id="main">
    <section class="card" aria-labelledby="title">
      <h1 id="title" class="brand">Gesti√≥n de Proyectos</h1>

      <form id="loginForm" novalidate>
        <div class="field">
          <label for="email">Correo electr√≥nico</label>
          <input
            id="email"
            name="email"
            type="email"
            placeholder="tucorreo@ejemplo.com"
            required
            autocomplete="username"
            aria-describedby="emailHelp"
          />
          <small id="emailHelp" class="hint">Usa tu correo</small>
          <p class="error" id="emailError" aria-live="polite"></p>
        </div>

        <div class="field">
          <label for="password">Contrase√±a</label>
          <div class="password-wrapper">
            <input
              id="password"
              name="password"
              type="password"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              required
              minlength="6"
              autocomplete="current-password"
              aria-describedby="pwdHelp"
            />
            <button type="button" class="toggle-pwd" id="togglePwd" aria-label="Mostrar contrase√±a">üëÅÔ∏è</button>
          </div>
          <small id="pwdHelp" class="hint">M√≠nimo 6 caracteres</small>
          <p class="error" id="pwdError" aria-live="polite"></p>
        </div>

        <button id="submitBtn" class="btn primary" type="submit">Iniciar sesi√≥n</button>

        <div class="or">√≥</div>

        <!-- Reemplazo por Google Login -->
        <div id="googleLogin" class="google-btn"></div>
        <p class="result" id="result" aria-live="polite"></p>
      </form>

    </section>
  </main>

  <!-- Supabase JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="app.js" defer></script>
  
  <!-- Google API SDK -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <script>
    const SUPABASE_URL = "https://uvhzeqemkmekgwhqczth.supabase.co";     // Reemplaza con tu URL de Supabase
    const SUPABASE_ANON_KEY = "tu-llave-publica";                          // Reemplaza con tu clave p√∫blica
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Referencias
    const form = document.getElementById("loginForm");
    const email = document.getElementById("email");
    const password = document.getElementById("password");
    const result = document.getElementById("result");
    const togglePwd = document.getElementById("togglePwd");

    // Funci√≥n para mostrar y ocultar contrase√±a
    togglePwd.addEventListener("click", () => {
      const showing = password.type === "text";
      password.type = showing ? "password" : "text";
      togglePwd.classList.toggle("is-on", !showing);
      togglePwd.setAttribute("aria-pressed", String(!showing));
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const mailVal = email.value.trim();
      const pwdVal = password.value;

      if (!mailVal || !pwdVal || pwdVal.length < 6) {
        result.textContent = "Correo o contrase√±a inv√°lidos.";
        result.style.color = "red";
        return;
      }

      result.textContent = "Iniciando sesi√≥n...";
      result.style.color = "green";

      const { data, error } = await supabase.auth.signInWithPassword({
        email: mailVal,
        password: pwdVal,
      });

      if (error) {
        result.textContent = error.message;
        result.style.color = "red";
        return;
      }

      // Redirige si el login es exitoso
      setTimeout(() => {
        window.location.href = "categorias.html";
      }, 1000);
    });

    // Configuraci√≥n del login con Google
    window.handleCredentialResponse = async (response) => {
      const dataGoogle = JSON.parse(atob(response.credential.split('.')[1]));
      const emailGoogle = dataGoogle.email;

      const { data: perfil, error } = await supabase
        .from('perfiles')
        .select('role')
        .eq('email', emailGoogle)
        .single();

      if (error || !perfil) {
        alert('‚ùå Este usuario no est√° registrado en el sistema.');
        return;
      }

      localStorage.setItem('auth', 'ok');
      localStorage.setItem('userEmail', emailGoogle);
      localStorage.setItem('role', perfil.role);

      if (perfil.role.toLowerCase() === 'administrador') {
        window.location.href = 'admin.html';
      } else {
        window.location.href = 'empleado.html';
      }
    };

    const GOOGLE_CLIENT_ID = "tu-client-id-google"; // Reemplaza con tu CLIENT_ID de Google
    window.onload = function () {
      google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: handleCredentialResponse,
      });
      google.accounts.id.renderButton(
        document.getElementById("googleLogin"),
        { theme: "outline", size: "large", width: "100%" }
      );
    };
  </script>
</body>
</html>
